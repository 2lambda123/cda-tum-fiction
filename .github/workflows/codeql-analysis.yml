name: CodeQL

on:
  push:
    branches: [ 'main' ]
    paths:
      - '**/*.hpp'
      - '**/*.cpp'
      - '**/*.cmake'
      - '**/CMakeLists.txt'
      - '**/*.py'
      - 'libs/**'
      - '.github/workflows/codeql-analysis.yml'
  pull_request:
    branches: [ 'main' ]
    paths:
      - '**/*.hpp'
      - '**/*.cpp'
      - '**/*.cmake'
      - '**/CMakeLists.txt'
      - '**/*.py'
      - 'libs/**'
      - '.github/workflows/codeql-analysis.yml'
  merge_group:
  schedule:
    - cron: '30 5 * * 6'

jobs:
  analyze:
    name: Analyze ${{ matrix.language }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp', 'python' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          config-file: .github/codeql-config.yml

      - if: matrix.language == 'cpp'
        name: Create Build Environment
        run: cmake -E make_directory ${{github.workspace}}/build

      - if: matrix.language == 'cpp'
        name: Configure CMake
        working-directory: ${{github.workspace}}/build
        run: >
          cmake ${{github.workspace}}
          -DFICTION_CLI=ON
          -DFICTION_TEST=ON
          -DFICTION_EXPERIMENTS=ON
          -DFICTION_Z3=ON
          -DFICTION_ENABLE_MUGEN=ON
          -DFICTION_PROGRESS_BARS=OFF
          -DMOCKTURTLE_EXAMPLES=OFF
          -DWARNINGS_AS_ERRORS=OFF

      - if: matrix.language == 'cpp'
        name: Build fiction
        working-directory: ${{github.workspace}}/build
        run: cmake --build .

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          upload: false
          output: sarif-results

      - name: Filter SARIF file to exclude library warnings
        uses: advanced-security/filter-sarif@main
        with:
          patterns: |
            -**/libs/**
          input: sarif-results/${{ matrix.language }}.sarif
          output: sarif-results/${{ matrix.language }}.sarif

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: sarif-results/${{ matrix.language }}.sarif
